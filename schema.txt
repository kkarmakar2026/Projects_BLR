-- sql/schema.sql

CREATE DATABASE IF NOT EXISTS quiz_portal CHARACTER SET utf8mb4 COLLATE utf8mb4_unicode_ci;
USE quiz_portal;

-- Admins
CREATE TABLE admins (
  id INT AUTO_INCREMENT PRIMARY KEY,
  username VARCHAR(50) UNIQUE NOT NULL,
  password_hash VARCHAR(255) NOT NULL,
  name VARCHAR(100),
  email VARCHAR(100),
  created_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP
);

-- Users
CREATE TABLE users (
  id INT AUTO_INCREMENT PRIMARY KEY,
  username VARCHAR(50) UNIQUE NOT NULL,
  password_hash VARCHAR(255) NOT NULL,
  name VARCHAR(100),
  email VARCHAR(100),
  created_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP
);

-- Questions
CREATE TABLE questions (
  id INT AUTO_INCREMENT PRIMARY KEY,
  text TEXT NOT NULL,
  option_a VARCHAR(255) NOT NULL,
  option_b VARCHAR(255) NOT NULL,
  option_c VARCHAR(255) NOT NULL,
  option_d VARCHAR(255) NOT NULL,
  correct_option ENUM('A','B','C','D') NOT NULL,
  created_by INT,
  FOREIGN KEY (created_by) REFERENCES admins(id) ON DELETE SET NULL
);

-- Quizzes
CREATE TABLE quizzes (
  id INT AUTO_INCREMENT PRIMARY KEY,
  name VARCHAR(150) NOT NULL,
  is_published TINYINT(1) DEFAULT 0,
  created_by INT,
  created_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP,
  FOREIGN KEY (created_by) REFERENCES admins(id) ON DELETE SET NULL
);

-- Quiz-Question mapping
CREATE TABLE quiz_questions (
  quiz_id INT NOT NULL,
  question_id INT NOT NULL,
  position INT DEFAULT 0,
  PRIMARY KEY (quiz_id, question_id),
  FOREIGN KEY (quiz_id) REFERENCES quizzes(id) ON DELETE CASCADE,
  FOREIGN KEY (question_id) REFERENCES questions(id) ON DELETE CASCADE
);

-- Attempts
CREATE TABLE attempts (
  id INT AUTO_INCREMENT PRIMARY KEY,
  quiz_id INT NOT NULL,
  user_id INT NOT NULL,
  score INT DEFAULT 0,
  started_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP,
  completed_at TIMESTAMP NULL,
  FOREIGN KEY (quiz_id) REFERENCES quizzes(id) ON DELETE CASCADE,
  FOREIGN KEY (user_id) REFERENCES users(id) ON DELETE CASCADE
);

show tables;
-- Attempt answers
CREATE TABLE attempt_answers (
  id INT AUTO_INCREMENT PRIMARY KEY,
  attempt_id INT NOT NULL,
  question_id INT NOT NULL,
  selected_option ENUM('A','B','C','D') NOT NULL,
  is_correct TINYINT(1) NOT NULL,
  FOREIGN KEY (attempt_id) REFERENCES attempts(id) ON DELETE CASCADE,
  FOREIGN KEY (question_id) REFERENCES questions(id) ON DELETE CASCADE
);

-- Seed an admin
INSERT INTO admins (username, password_hash, name, email)
VALUES ('admin', '$2a$10$ZWvxlM5v0/wFc6iEsKv6FOVpc5Nzx.n4NG1aruGcXtr./Io.i.0Hm', 'Koushik Karmakar', 'koushik.karmakar26@gmail.com');
-- Note: This hash should be replaced with a real bcrypt hash you generate for 'admin123'

USE quiz_portal;
ALTER TABLE quizzes ADD COLUMN time_limit INT DEFAULT 10; -- Default 10 minutes


-- 1. Modify 'quizzes' table to add 'category' (and ensure time_limit exists)
ALTER TABLE quizzes 
ADD COLUMN category VARCHAR(100) DEFAULT 'General' AFTER name;

-- Note: You already have time_limit in your snippet, but if it's missing, uncomment below:
-- ALTER TABLE quizzes ADD COLUMN time_limit INT DEFAULT 10;


-- 2. Create the 'results' table
-- This is required because your ResultServlet and DAO are specifically looking 
-- for a table named 'results' with 'total_marks' and 'score' as decimals.
CREATE TABLE results (
  id INT AUTO_INCREMENT PRIMARY KEY,
  user_id INT NOT NULL,
  quiz_id INT NOT NULL,
  score DOUBLE DEFAULT 0.0,       -- Uses DOUBLE for precise percentage calc
  total_marks DOUBLE DEFAULT 0.0, -- Needed to calculate percentage (score / total * 100)
  attempt_datetime TIMESTAMP DEFAULT CURRENT_TIMESTAMP,
  
  FOREIGN KEY (user_id) REFERENCES users(id) ON DELETE CASCADE,
  FOREIGN KEY (quiz_id) REFERENCES quizzes(id) ON DELETE CASCADE
);



-- Add the missing column to the attempts table
ALTER TABLE attempts 
ADD COLUMN total_marks DOUBLE DEFAULT 0.0 AFTER score;

-- Optional: Ensure score can hold decimals if needed
ALTER TABLE attempts MODIFY COLUMN score DOUBLE DEFAULT 0.0;